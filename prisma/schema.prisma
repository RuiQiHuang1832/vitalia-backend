// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client-js"
  moduleFormat = "esm"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  PATIENT
  PROVIDER
  ADMIN
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum ProblemStatus {
  ACTIVE
  RESOLVED
}

enum AllergySeverity {
  MILD
  MODERATE
  SEVERE
}

enum AllergyCategory {
  FOOD
  MEDICATION
  ENVIRONMENTAL
  OTHER
}

enum MedicationStatus {
  ACTIVE
  COMPLETED
  DISCONTINUED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
}

enum AuditEntity {
  USER
  PATIENT
  PROVIDER
  APPOINTMENT
  VISIT_NOTE
  PROBLEM
  ALLERGY
  MEDICATION
  VITAL
  PROVIDER_AVAILABILITY
}

enum Gender {
  MALE
  FEMALE
  UNSPECIFIED
}

enum PatientStatus {
  ACTIVE
  INACTIVE
  DISCHARGED
}

// ---------- USERS & AUTH ----------

model User {
  id               Int        @id @default(autoincrement())
  email            String     @unique
  password         String
  role             Role       @default(PATIENT)
  createdAt        DateTime   @default(now())
  refreshToken     String?
  sessionStartedAt DateTime?
  rememberMe       Boolean    @default(false)
  patient          Patient?
  provider         Provider?
  auditLogs        AuditLog[]
}

// ---------- PATIENTS ----------

model Patient {
  id     Int  @id @default(autoincrement())
  userId Int? @unique
  // Relations, not stored in DB directly

  user         User?         @relation(fields: [userId], references: [id])
  firstName    String
  lastName     String
  dob          DateTime
  gender       Gender        @default(UNSPECIFIED)
  phone        String
  email        String
  createdAt    DateTime      @default(now())
  status       PatientStatus @default(ACTIVE)
  appointments Appointment[]
  problems     Problem[]
  allergies    Allergy[]
  medications  Medication[]
  vitals       Vital[]
}

// ---------- PROVIDERS ----------

model Provider {
  id     Int  @id @default(autoincrement())
  userId Int? @unique
  // Relations, not stored in DB directly

  user      User?    @relation(fields: [userId], references: [id])
  firstName String
  lastName  String
  specialty String
  phone     String
  email     String   @unique
  createdAt DateTime @default(now())

  appointments         Appointment[]
  visitNotes           VisitNote[]
  visitNoteVersions    VisitNoteEntry[]      @relation("ProviderEdits")
  problems             Problem[]
  allergies            Allergy[]
  medications          Medication[]
  vitals               Vital[]
  providerAvailability ProviderAvailability?
}

// ---------- APPOINTMENTS ----------

model Appointment {
  id         Int               @id @default(autoincrement())
  providerId Int
  patientId  Int
  provider   Provider          @relation(fields: [providerId], references: [id], onDelete: Cascade)
  patient    Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  startTime  DateTime
  endTime    DateTime
  reason     String?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  status     AppointmentStatus @default(SCHEDULED)
  visitNote  VisitNote?
  vitals     Vital[]
}

// ---------- Visit Notes ----------
// Parent model for visit notes associated with an appointment.
model VisitNote {
  id            Int  @id @default(autoincrement())
  appointmentId Int  @unique
  providerId    Int
  latestVersion Int? // Points to the most recent VisitNoteEntry

  // Relations
  appointment Appointment      @relation(fields: [appointmentId], references: [id])
  provider    Provider         @relation(fields: [providerId], references: [id])
  versions    VisitNoteEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Versions of a visit note, tracking edits over time.
model VisitNoteEntry {
  id          Int    @id @default(autoincrement())
  visitNoteId Int
  version     Int // 1, 2, 3...
  content     String
  editedById  Int // provider who made this version

  // Relations
  visitNote VisitNote @relation(fields: [visitNoteId], references: [id])
  editedBy  Provider  @relation("ProviderEdits", fields: [editedById], references: [id])

  createdAt DateTime @default(now())

  @@unique([visitNoteId, version]) // Prevent duplicate version numbers per VisitNote
  @@index([visitNoteId]) // Improve performance when querying versions
}

// ---------- Problem List ----------
model Problem {
  id         Int @id @default(autoincrement())
  patientId  Int
  providerId Int

  name        String
  icdCode     String? // optional ICD-10 diagnostic code
  description String? // provider notes
  status      ProblemStatus @default(ACTIVE)

  createdAt  DateTime  @default(now())
  resolvedAt DateTime? // only used if status = RESOLVED

  // Relations
  patient  Patient  @relation(fields: [patientId], references: [id])
  provider Provider @relation(fields: [providerId], references: [id])
}

// ---------- Allergy ----------

model Allergy {
  id           Int              @id @default(autoincrement())
  patientId    Int
  recordedById Int
  category     AllergyCategory
  substance    String
  reaction     String?
  severity     AllergySeverity?
  notes        String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // Relations
  patient  Patient  @relation(fields: [patientId], references: [id])
  provider Provider @relation(fields: [recordedById], references: [id])
}

// ---------- Medication ----------

model Medication {
  id           Int              @id @default(autoincrement())
  patientId    Int
  prescribedBy Int
  name         String
  dosage       String
  frequency    String
  startDate    DateTime
  endDate      DateTime?
  status       MedicationStatus @default(ACTIVE)
  notes        String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // Relations
  patient  Patient  @relation(fields: [patientId], references: [id])
  provider Provider @relation(fields: [prescribedBy], references: [id])
}

// ---------- Vitals ----------
model Vital {
  id                     Int      @id @default(autoincrement())
  appointmentId          Int
  patientId              Int
  providerId             Int
  heartRate              Int?
  bloodPressureSystolic  Int?
  bloodPressureDiastolic Int?
  temperature            Float?
  weight                 Float?
  oxygenSaturation       Int?
  recordedAt             DateTime @default(now())

  // Relations
  patient     Patient     @relation(fields: [patientId], references: [id])
  provider    Provider    @relation(fields: [providerId], references: [id])
  appointment Appointment @relation(fields: [appointmentId], references: [id])
}

// ---------- AUDIT LOG ----------
model AuditLog {
  id        Int         @id @default(autoincrement())
  userId    Int
  userRole  Role
  action    AuditAction
  entity    AuditEntity
  entityId  Int
  createdAt DateTime    @default(now())
  details   Json?

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
}

// ---------- PROVIDER AVAILABILITY ----------
enum Weekday {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
}

model ProviderAvailability {
  id Int @id @default(autoincrement())

  providerId Int      @unique
  provider   Provider @relation(fields: [providerId], references: [id])

  workingDays Weekday[]
  startTime   DateTime
  endTime     DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
